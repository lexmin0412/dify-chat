# 构建阶段
FROM node:22.5.1-alpine AS builder
WORKDIR /app

# 复制 package.json 文件
COPY packages/platform/package.json ./packages/platform/
COPY packages/api/package.json ./packages/api/
COPY packages/components/package.json ./packages/components/
COPY packages/core/package.json ./packages/core/
COPY packages/helpers/package.json ./packages/helpers/
COPY packages/theme/package.json ./packages/theme/
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

RUN npm install pnpm@10.8.1 -g
RUN pnpm install

# 复制所有源码
COPY packages/platform/ ./packages/platform/
COPY packages/api/ ./packages/api/
COPY packages/components/ ./packages/components/
COPY packages/core/ ./packages/core/
COPY packages/helpers/ ./packages/helpers/
COPY packages/theme/ ./packages/theme/
# components 子包中依赖了 react-app 的 tailwind.config.js，后续优化移除这个依赖关系
COPY packages/react-app/ ./packages/react-app/
COPY tsconfig.prod.json ./

# 构建子包
RUN pnpm build:pkgs
# 构建 platform
RUN pnpm --filter dify-chat-platform build

FROM node:22.5.1-alpine AS runner

WORKDIR /app

# 复制整个 standalone 目录（包含所有必需的文件和依赖）
COPY --from=builder /app/packages/platform/.next/standalone ./
COPY --from=builder /app/packages/platform/.next/static ./packages/platform/.next/static
COPY --from=builder /app/packages/platform/public ./packages/platform/public

# 复制迁移相关文件
COPY --from=builder /app/packages/platform/migrations ./packages/platform/migrations
COPY --from=builder /app/packages/platform/lib/typeorm.config.ts ./packages/platform/lib/typeorm.config.ts

# 安装 TypeORM CLI（运行时需要）
RUN npm install -g typeorm@0.3.27

ENV NODE_ENV=production
ENV PORT=5300

EXPOSE 5300

# 启动时先运行迁移，然后启动应用
CMD ["sh", "-c", "cd packages/platform && npx typeorm migration:run -d lib/typeorm.config.ts && cd /app && node packages/platform/server.js"]
