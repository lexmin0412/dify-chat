# 构建阶段
FROM node:22.5.1-alpine AS builder
WORKDIR /app

# 复制 package.json 文件
COPY packages/platform/package.json ./packages/platform/
COPY packages/api/package.json ./packages/api/
COPY packages/components/package.json ./packages/components/
COPY packages/core/package.json ./packages/core/
COPY packages/helpers/package.json ./packages/helpers/
COPY packages/theme/package.json ./packages/theme/
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

RUN npm install pnpm@10.8.1 -g
RUN pnpm install

# 复制所有源码
COPY packages/platform/ ./packages/platform/
COPY packages/api/ ./packages/api/
COPY packages/components/ ./packages/components/
COPY packages/core/ ./packages/core/
COPY packages/helpers/ ./packages/helpers/
COPY packages/theme/ ./packages/theme/
# components 子包中依赖了 react-app 的 tailwind.config.js，后续优化移除这个依赖关系
COPY packages/react-app/ ./packages/react-app/
COPY tsconfig.prod.json ./

# 构建子包
RUN pnpm build:pkgs
# 构建 platform（Next.js）
RUN pnpm --filter dify-chat-platform build
# 编译 TypeORM（配置/实体/迁移）为 JS
RUN pnpm --filter dify-chat-platform build:orm

FROM node:22.5.1-alpine AS runner

WORKDIR /app

# 复制整个 standalone 目录（包含所有必需的文件和依赖）
COPY --from=builder /app/packages/platform/.next/standalone ./
COPY --from=builder /app/packages/platform/.next/static ./packages/platform/.next/static
COPY --from=builder /app/packages/platform/public ./packages/platform/public

# 复制编译后的 TypeORM 配置/实体/迁移（运行所需）
COPY --from=builder /app/packages/platform/dist-orm ./packages/platform/dist-orm
# 运行时通过 --env-file 注入环境变量，CLI 将从 process.env 读取

# 全局安装 TypeORM CLI；将运行时依赖安装到 /deps 以避开 workspace 影响
RUN npm install -g typeorm@0.3.27
RUN npm install --omit=dev --no-audit --no-fund --prefix /deps typeorm@0.3.27 mysql2@3.15.2 reflect-metadata@0.2.0 dotenv@16.4.5

ENV NODE_PATH=/deps/node_modules
ENV NODE_ENV=production
ENV PORT=5300

EXPOSE 5300

# 启动时先运行迁移（使用已编译 JS 配置），然后启动应用（Next standalone）
CMD ["sh", "-c", "cd packages/platform && RUN_MIGRATIONS=true npx typeorm migration:run -d dist-orm/lib/typeorm.cli.config.js && cd /app && node packages/platform/server.js"]
